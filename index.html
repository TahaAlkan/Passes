<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Passes — TLE Pass Finder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --muted: #9aa4b2;
      --accent: #3b82f6;
      --glass: rgba(255,255,255,0.03);
      --radius: 12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#061226 0%, #071428 100%);
      color:#e6eef8;
      padding:20px;
      -webkit-font-smoothing:antialiased;
    }
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);box-shadow:0 6px 24px rgba(2,6,23,0.6);margin-bottom:16px}
    label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted)}
    input[type="text"], input[type="number"], select, textarea {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.04);
      background:var(--glass);
      color:inherit;
      resize:vertical;
      font-size:13px;
    }
    textarea{min-height:120px;font-family:Menlo,monospace}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .small{font-size:12px;color:var(--muted)}
    button{
      background:var(--accent);
      color:white;
      padding:10px 14px;
      border:0;border-radius:8px;
      cursor:pointer;font-weight:600;
    }
    .muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:600}
    .flex{display:flex;align-items:center;gap:8px}
    .inline{display:inline-flex;align-items:center;gap:8px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap}
    a.link{color:var(--accent);text-decoration:none;font-size:13px}
    .footer{color:var(--muted);font-size:13px;margin-top:8px}
    .status{color:var(--muted);font-size:13px;margin-top:6px}
    @media (max-width:720px){
      .row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Passes — TLE Pass Finder</h1>
        <p class="lead">Compute satellite passes from TLE, sort by time, export as CSV.</p>
      </div>
      <div class="top-actions">
        <button id="computeBtn">Compute Passes</button>
        <button id="downloadCsvBtn" class="muted-btn">Export CSV</button>
        <button id="clearBtn" class="muted-btn">Clear Results</button>
      </div>
    </header>

    <section class="card">
      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div style="min-width:260px;">
          <label>TLE Input</label>
          <textarea id="tleInput"></textarea>
          <div class="small" style="margin-top:6px">Default: ISS (ZARYA)</div>
        </div>

        <div style="min-width:220px;">
          <label>Observer location</label>
          <div class="row" style="margin-bottom:6px">
            <input id="lat" type="number" step="0.0001" value="41.0082" placeholder="Latitude">
            <input id="lon" type="number" step="0.0001" value="28.9784" placeholder="Longitude">
            <input id="height" type="number" step="1" value="50" placeholder="Height (m)">
          </div>
          <div class="small">Default: Istanbul</div>
        </div>

        <div style="min-width:220px;">
          <label>Computation settings</label>
          <input id="hours" type="number" value="24" min="1">
          <div class="small">Hours ahead (UTC)</div>
        </div>

        <div style="min-width:220px;">
          <label>Elevation threshold</label>
          <input id="elThreshold" type="number" value="5" min="0">
          <div style="margin-top:8px" class="inline">
            <label class="small">Time display</label>
            <select id="timeMode">
              <option value="local">Local</option>
              <option value="utc">UTC</option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="resultsCard">
      <h2 style="margin-top:0">Results</h2>
      <div class="status" id="status">Ready. (SGP4, start = current UTC)</div>
      <div id="resultsContainer"></div>
    </section>

    <footer class="footer">
      Built with <a class="link" href="https://github.com/shashwatak/satellite-js" target="_blank">satellite.js</a> (SGP4)
    </footer>
  </div>

  <script src="https://unpkg.com/satellite.js@4.1.4/dist/satellite.min.js"></script>
  <script>
    const tleInputEl=document.getElementById('tleInput');
    const computeBtn=document.getElementById('computeBtn');
    const clearBtn=document.getElementById('clearBtn');
    const downloadCsvBtn=document.getElementById('downloadCsvBtn');
    const statusEl=document.getElementById('status');
    const resultsContainer=document.getElementById('resultsContainer');
    const latEl=document.getElementById('lat');
    const lonEl=document.getElementById('lon');
    const heightEl=document.getElementById('height');
    const hoursEl=document.getElementById('hours');
    const elThresholdEl=document.getElementById('elThreshold');
    const timeModeEl=document.getElementById('timeMode');
    let latestPassResults=[];

    tleInputEl.value=`ISS (ZARYA)
1 25544U 98067A   25344.51782528  .00001264  00000-0  29628-4 0  9991
2 25544  51.6442 203.3076 0005631  39.9456 320.2334 15.50068472295969`;

    function formatDate(dateObj){
      if(timeModeEl.value==='utc'){
        return new Date(dateObj).toISOString().replace('T',' ').replace('Z',' UTC');
      }else return new Date(dateObj).toLocaleString();
    }

    function parseTLEs(text){
      const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const groups=[];
      for(let i=0;i<lines.length;){
        if(lines[i].startsWith('1 ')) groups.push(['',lines[i],lines[i+1]]),i+=2;
        else groups.push([lines[i],lines[i+1],lines[i+2]]),i+=3;
      }
      return groups;
    }

    // ✅ High-precision look angle computation
    function computeLookAngles(satrec, jsDate, observerGeodetic){
      const j = satellite.jday(
        jsDate.getUTCFullYear(),
        jsDate.getUTCMonth()+1,
        jsDate.getUTCDate(),
        jsDate.getUTCHours(),
        jsDate.getUTCMinutes(),
        jsDate.getUTCSeconds() + jsDate.getUTCMilliseconds() * 1e-3
      );
      const gmst = satellite.gstime(j); // ✅ Works fine in v4.1.4

      const eci = satellite.propagate(satrec, jsDate);
      if(!eci || !eci.position) return null;

      const positionEcf = satellite.eciToEcf(eci.position, gmst);
      let lon = observerGeodetic.lon;
      if(lon > 180) lon -= 360;
      if(lon < -180) lon += 360;

      const obs = {
        longitude: satellite.degreesToRadians(lon),
        latitude: satellite.degreesToRadians(observerGeodetic.lat),
        height: observerGeodetic.height / 1000.0
      };
      const look = satellite.ecfToLookAngles(obs, positionEcf);
      return {
        az: satellite.radiansToDegrees(look.azimuth),
        el: satellite.radiansToDegrees(look.elevation),
        rangeKm: look.rangeSat
      };
    }

    async function findPassesForTle(tleTuple,observer,startDate,hours,elevThreshold){
      const endDate=new Date(startDate.getTime()+hours*3600*1000);
      const satrec=satellite.twoline2satrec(tleTuple[1],tleTuple[2]);
      const observerGeodetic={lon:observer.lon,lat:observer.lat,height:observer.height};
      const stepSec=1; // ✅ more precise
      const results=[];
      let inPass=false,passStart=null,maxEl=-Infinity,maxTime=null;
      for(let t=new Date(startDate.getTime());t<=endDate;t=new Date(t.getTime()+stepSec*1000)){
        const look=computeLookAngles(satrec,t,observerGeodetic);
        if(!look)continue;
        const el=look.el;
        if(el>=elevThreshold){
          if(!inPass){inPass=true;passStart=new Date(t);maxEl=el;maxTime=new Date(t);}
          else if(el>maxEl){maxEl=el;maxTime=new Date(t);}
        }else if(inPass){
          const passEnd=new Date(t-stepSec*1000);
          results.push({sat:tleTuple[0]||'SAT',start:passStart,end:passEnd,maxEl,maxTime});
          inPass=false;
        }
      }
      if(inPass)results.push({sat:tleTuple[0]||'SAT',start:passStart,end:endDate,maxEl,maxTime});
      return results;
    }

    async function findPasses(tleTuples,observer,hours,elevThreshold){
      statusEl.textContent='Computing passes... (start = current UTC)';
      const start=new Date(Date.now());
      const all=[];
      for(const tle of tleTuples){
        try{
          const passes=await findPassesForTle(tle,observer,start,hours,elevThreshold);
          all.push(...passes);
        }catch(e){console.error('Error computing passes',e);}
      }
      all.sort((a,b)=>new Date(a.start)-new Date(b.start));
      statusEl.textContent=`Done — ${all.length} pass(es) found.`;
      return all;
    }

    function renderResults(passes){
      latestPassResults=passes;
      if(passes.length===0){resultsContainer.innerHTML='<div class="small">No passes found.</div>';return;}
      let html='<table><thead><tr><th>Satellite</th><th>Start</th><th>End</th><th>Max Elev (°)</th><th>Max Elev Time</th></tr></thead><tbody>';
      for(const p of passes){
        html+=`<tr><td>${p.sat}</td><td>${formatDate(p.start)}</td><td>${formatDate(p.end)}</td><td>${p.maxEl.toFixed(2)}</td><td>${formatDate(p.maxTime)}</td></tr>`;
      }
      html+='</tbody></table>';
      resultsContainer.innerHTML=html;
    }

    computeBtn.onclick=async()=>{
      const observer={lat:parseFloat(latEl.value),lon:parseFloat(lonEl.value),height:parseFloat(heightEl.value)};
      const tleText=tleInputEl.value.trim();if(!tleText){alert('Enter TLE');return;}
      const tleTuples=parseTLEs(tleText);
      const passes=await findPasses(tleTuples,observer,parseFloat(hoursEl.value),parseFloat(elThresholdEl.value));
      renderResults(passes);
    };

    clearBtn.onclick=()=>{
      latestPassResults=[];
      resultsContainer.innerHTML='';
      statusEl.textContent='Results cleared.';
    };

    downloadCsvBtn.onclick=()=>{
      if(latestPassResults.length===0){alert('No results to export.');return;}
      const header='Satellite,Start,End,Max Elev (deg),Max Elev Time\n';
      const csv=header+latestPassResults.map(p=>`${p.sat},${p.start.toISOString()},${p.end.toISOString()},${p.maxEl.toFixed(2)},${p.maxTime.toISOString()}`).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download='passes.csv';a.click();URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
